#include <ncurses.h>
#include <unistd.h>
#include <stdlib.h>

#define WIDTH 80
#define HEIGHT 30

#define GREEN 4
#define RED 3

#define MAX_BULLETS 20
#define BULLET_LIFE 10

#define MAX_MOBS 10

#define STEP 20
#define RAND_MAX 100

typedef enum {north,east,south,west} dir;

typedef struct {
	int x;
	int y;
	int colour;
	char character;
	dir direction;
	int life;
} dude;

typedef struct {
	int x;
	int y;
	dir direction;
	int damage;
	int speed;
	int life;
	int colour;
} bullet;

int nextBullet = 0;
bullet bullets[MAX_BULLETS] = {-1,-1,north,0,0,-1, RED};

int nextMob = 0;
dude mobs[MAX_MOBS] = {-1,-1,RED,'@',north, -1};

char map[HEIGHT][WIDTH] = {
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','+','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','+','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','+','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','+','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','#','#','+','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','+','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','+','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','#',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','+','#','#',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','+','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','+','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',},
	{' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',}
};

dude player = {10,4,2,' ', south, 10};

void drawBlock(dude obj){
	attron(COLOR_PAIR(obj.colour));
	mvaddch(obj.y,obj.x,obj.character);
	attroff(COLOR_PAIR(obj.colour));
}

void drawMap(char data[HEIGHT][WIDTH]){
	int x,y;
	for (y = 0; y < HEIGHT; y++){
		for (x = 0; x < WIDTH; x++) {
			//attron(COLOR_PAIR(data[y][x]));
			mvaddch(y,x,data[y][x]);
			//attron(COLOR_PAIR(data[y][x]));	
		}
	}
}

void drawMobs() {
	int i;
	for (i = 0; i < MAX_MOBS; i++) {
		if (mobs[i].life > -1) {
			drawBlock(mobs[i]);
		}
	}
}

void drawBullets(){
	int i;
	for (i = 0; i < MAX_BULLETS; i++){
		if (bullets[i].life > -1) {
			char c;
			// switch (bullets[i].direction) {
			// 	case north:
			// 	case south:
			// 		c = 'o';
			// 		break;
			// 	case east:
			// 	case west:
			// 		c = 'o';
			// 		break;
			// }
			attron(COLOR_PAIR(RED));
			mvaddch(bullets[i].y,bullets[i].x,'o');
			attroff(COLOR_PAIR(RED));
		}
	}
}

void spawnMob(){
	mobs[nextMob].x = 4;
	mobs[nextMob].y = 4;
	mobs[nextMob].life = 10;
	nextMob++;
	if (nextMob == MAX_MOBS) {
		nextMob = 0;
	}
}

void updateMobs(){
	if (rand() < 10) {
		spawnMob();
	}
	int i;
	for (i = 0; i < MAX_MOBS; i++) {
		if (mobs[i].life > -1) {

		} else {
			nextMob = i;
		}
	}
}

void updateBullets(){
	int i;
	for (i = 0; i < MAX_BULLETS; i++) {
		if (bullets[i].life > -1) {
			switch (bullets[i].direction) {
				case north:
					bullets[i].y-=bullets[i].speed;
					break;
				case south:
					bullets[i].y+=bullets[i].speed;
					break;
				case east:
					bullets[i].x+=bullets[i].speed;
					break;
				case west:
					bullets[i].x-=bullets[i].speed;
					break;
			}
			bullets[i].life--;
			if (!canMove(bullets[i].x,bullets[i].y)) { bullets[i].life = -1; }
			if (bullets[i].life == -1) {
				nextBullet = i;
			}
		}
	}
}

void fireBullet(dude from, int speed, int damage){
	bullets[nextBullet].x = from.x;
	bullets[nextBullet].y = from.y;
	bullets[nextBullet].direction = from.direction;
	bullets[nextBullet].speed = speed;
	bullets[nextBullet].damage = damage;
	bullets[nextBullet].life = BULLET_LIFE;
	nextBullet++;
	if (nextBullet == MAX_BULLETS) {
		nextBullet = 0;
	}
}

int canMove(int x, int y) {
	if (map[y][x] == '+') {
		return 1;
	}	else {
		return 0;
	}
}

void render(){
	clear();
	drawMap(map);
	drawBullets();
	//drawMobs();
	drawBlock(player);
	refresh();
}

void update(){
	updateBullets();
	updateMobs();
}

void main(){

	srand(1234);

	initscr();
	cbreak();
	nodelay(stdscr, TRUE);
	keypad(stdscr, TRUE);
	noecho();
	curs_set(0);
	start_color();

	init_pair(1,COLOR_WHITE,COLOR_BLACK);
	init_pair(2,COLOR_WHITE,COLOR_BLUE);
	init_pair(RED,COLOR_RED,COLOR_BLACK);
	init_pair(GREEN,COLOR_GREEN,COLOR_BLACK);


	int step = STEP*1000;
	int in;
	int running = 1;
	while (running) {
		usleep(step);
		in = getch();
		switch(in){
			case 'q':
				running = 0;
				break;
			case KEY_UP:
				player.direction = north;
				if (canMove(player.x,player.y-1)) { player.y--; }
				break;
			case KEY_DOWN:
				player.direction = south;
				if (canMove(player.x,player.y+1)) { player.y++; }
				break;
			case KEY_RIGHT:
				player.direction = east;
				if (canMove(player.x+1,player.y)) { player.x++; }
				break;
			case KEY_LEFT:
				player.direction = west;
				if (canMove(player.x-1,player.y)) { player.x--; }
				break;
			case 'z':
				fireBullet(player,1,1);
			default:
				break;
		}
		update();
		render();
	}
	endwin();
	return;
}

